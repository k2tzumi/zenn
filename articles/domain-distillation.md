---
title: "アーキテクチャレベルで依存性を逆転させたら最高だった件"
emoji: "🔃"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["アドベントカレンダー","Microservice","DDD"]
published: false
publication_name: "litalico"
published_at: 2024-12-19 00:00
---
:::message
この記事は [LITALICO Advent Calendar 2024](https://qiita.com/advent-calendar/2024/litalico)のシリーズ 1 の 12/19 配信になります。
:::

## はじめに

LITALICO の @katzumi です。
LITALICO に 2020 年に Join してから、ずっとレセプト業務に携わる開発を行ってきました。　　
レセプト業務はドメインが複雑でミスが許されず、また３年に一度の大きな報酬改定がありロジックがガラッと変わります。
またその改訂作業自体が非常に短期間で行う必要があり、年々と複雑化するシステムと向き合う必要があります。

その複雑な業務に立ち向かった内容を過去にも以下の内容で開発業務の記事を書いていました。

https://zenn.dev/litalico/articles/confronting-law-amends-with-microservices

https://zenn.dev/litalico/articles/confronting-law-amends-with-microservices2

https://zenn.dev/litalico/articles/re-architecting-rezept

https://zenn.dev/litalico/articles/re-architecting-rezept2

今年 2024 年は法改正の年になっており、取り組みの結果その後はどうなったのか？を振り返っていきます。

## 今回も壮絶だった法改正

私自身の大規模法改正の経験が今回で 2 回目となります。
チーム構成としては私ともう一名を除いて前回の　2021 年度法改正を経験したメンバーがいませんでした。
また前回は３種類のサービスのみの対応だったのが、ビジネスの拡大に伴い 3x 種類^[対応範囲が膨大となる為、旧システムでの連携もまだ残っており、法改正時点で実際連携したのは10サービスのみとなりました]のサービスまで拡大する必要がありました。
また今回の法改正の為に新規で作成した Rezept as a Service で初めて法改正を迎えるという内容でした。
この Rezept as a Servie が各プロダクトと連携を開始した直後での法改正の対応となりました。

今年は補正予算の都合もあり、4 月から２ヶ月間のみに有効になる加算があったり、請求システムを構築する上で必要となる情報が例年よりも数日遅れで公開されるなど大分ばたつきました。
4 月に施行される情報が前年 12 月から五月雨式に公開されていく中ではこの数日はかなりインパクトがある内容となります。
本格的な設計が 2 月から開始し、4 月末にはテストを完了させてリリースしないといけないというスケジュールはやはり痺れるものがあります。
また報酬制度も積み上げで複雑化しており、とあるサービスで利用するサービスコードの数が３倍になっていました。
このサービスコードというのは請求の条件を表したもので、このコードの数分の請求パターンが存在することになります。純粋に考えると前回よりも３倍のテストが必要なことになります。 ^[全てのパターンでの検証は難しい為、品質を担保する為に工夫はしていてテストケース数が３倍にならない様にしています。それでも複雑度が上がっていることをご理解いただけるのではないでしょうか？]

## システム構成

レセプト基盤はマルチテナントなシステムとして構築していますが、データ管理およびシステム構成上の都合からシングルユースな構成として、各プロダクトの VPC 上に構築する様にしています。

TODO:

## コアドメインを見定めるということ

複数プロダクトから利用される Rezept as a Service として構築がされていますが、この構成になるにはコアドメインの見定めが必要となります。
例えば請求業務の中でも利用者への負担額請求は、以前のシステムでは 1 つのマイクロサービスとして定義していましたが、これは明確にレセプトの業務外として定義して分けました。
これはほんの一例ですが、レセプト業務に向き合ってより本質を見定めて責務を明確にするということをおこなってきました。
そうすることで、各プロダクト固有の機能に振り回されなくなります。

## 依存性を逆転させる

Rezept as a Service が提供しているインターフェースを通して各プロダクトはレセプト業務を行える様になっています。
レセプト業務自体は、事業所の体制の情報や支援した内容の実績等のデータを収集して請求の計算処理を行います。
データフロー的にはレセプト業務は下流の方になります。
このデータの依存は以前のシステムでは存在し、法改正時に実績データの仕様が決定されないとレセプト側の設計・実装が進まないという問題がありました。
今回この依存の部分を API のインターフェースとして定義することで、このインターフェースに各プロダクトから依存させる形にできました。
これは SOLID 原則にある依存関係逆転の原則（dependency inversion principle）を適用されることになります。
Rezept as a Service が上位モジュール、各プロダクトが下位モジュールとして定義されることになり、各プロダクトの仕様変更がコアドメインであるレセプト業務に影響を及ぼす事がなくなります。

## コアドメインとして依存をなくすことのメリット

コアドメインの見定めと、依存性を逆転させるということはドメイン駆動設計（エヴァンス本）にあるドメインの蒸留になります。
混ざり合ったコンポーネントが分離されています。これは依存させるものを無くし、一番サービスとして安定させる為に行なっています。
一番安定させることでスキーマ駆動開発で Rezept as a Service と各プロダクトが並行開発を行える様になります。
冒頭で触れましたが、法改正は非常にタイトなスケジュールで進行するので手戻りが許されません。
実績データをどの様に蓄積するか？というのは各プロダクトが非常に強い関心をもって作り込みを行なっています。
これはいつまでの実績データの仕様が決まらないということになりガチになります。不安定なものに依存するとシステム全体が不安定になります。
手戻りなく迅速に法改正対応をさせ、システム全体を安定ささるには、レセプト業務を一番安定させる必要がありました。

## コミュニケーション設計の重要性

Rezept as a Service に各プロダクトが依存することになることから、重要になってくるのがコミュニケーションになります。
複数チームからの問い合わせによって、コミュニケーションコストの増大が懸念されました。
如何にコミュニケーションコストを少なくできるか？という所が重要だと考えました。


## 一番安定させる為に

Rezept as a Service を一番安定させる為に、色々な取り組みを行っていました。
BaaS で API しか存在しないアプリケーションになるのでテストをどの様にしていくか？悩んでいました。
この API のテストやインターフェースの品質を高める取り組みは以下の記事で取り上げました。

https://zenn.dev/litalico/articles/re-architecting-rezept2

この中で特に API シナリオテストが重要な技術要素として [runn](https://github.com/k1LoW/runn) がありました。
runn については以下の記事を参考にしてください

https://zenn.dev/katzumi/articles/api-scenario-testing-with-runn

興味を持たれた方は去年一人アドベントカレンダーした記事を取りまとめたチュートリアルを本でまとめましたので良かったらどうぞ。

https://zenn.dev/katzumi/books/runn-tutorial

あともう 1 つ宣伝となりますが、スキーマ駆動開発の取り組みの一部をライブラリ OSS 化しました。こちらも良かったらお願いします！

https://zenn.dev/litalico/articles/what-is-eg-r2


## 2度にリアーキテクチャしたことについて



# 最後に

TODO
　
:::message
明日は、[LITALICO Advent Calendar 2024](https://qiita.com/advent-calendar/2024/litalico) 20 日目の記事です。[@enochan](https://qiita.com/enochan) さん、　[@bashiiko](https://qiita.com/bashiiko)さん、[@ryunosuke_sako](https://qiita.com/ryunosuke_sako)と[@ayami_n](https://qiita.com/ayami_n)さんが担当し、豪華４本立てになります！どうぞお楽しみに！
:::
