---
title: "関心ごとにも依存関係がある"
emoji: "🔗"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["アドベントカレンダー","Microservice","DDD"]
published: false
publication_name: "litalico"
published_at: 2025-12-18 00:00
---
:::message
この記事は [LITALICO Advent Calendar 2025](https://qiita.com/advent-calendar/2025/litalico)のシリーズ 1 の 12/18 分の記事になります。
:::

## はじめに

LITALICO の @katzumi です。
[去年のアドベントカレンダー](https://zenn.dev/litalico/articles/domain-distillation)の続編となる内容となります。

 こちらのアドベントカレンダーの内容を元に [PHPカンファレンス福岡2025](https://phpcon.fukuoka.jp/2025/) にて登壇をしてきました。

## PHPカンファレンス福岡2025での登壇内容

### 戦術から戦略へ - 4年半の取り組みの集大成

去年の記事はどちらかというと戦術面（How）にフォーカスを当てた内容でしたが、そこから掘り下げて戦略面（Why）も追加した内容となっています。  
2020年から4年半かけて行ってきた取り組みの集大成的な位置づけとしてまとめていきました。

詳細は以下のスライドをご参照ください。

@[docswell](https://www.docswell.com/s/katzumi/ZN9P7G-domain-distillation)

### 登壇への反響

セッションを聞かれたきんじょうさんから以下の感想を貰いました。

https://x.com/o0h_/status/1987047195779207227?s=20

本記事では、登壇スライド作成時に本編から切り出すか悩んだ『組織論』についてお話しします。

## BaaS化への道のり - 専門チームの誕生

### 法改正のコアを扱う専門チーム

スライドでも触れていますが、今回の事業戦略としてBaaSを開発するチームを作りました。

最初から言語化できていたわけではないですが、法改正のコアとなる関心ごとを扱う専門チームとなりました。
ただBaaSに接続するサービス構築時には構想はあった様です。その為、初期段階からマイクロサービス・クリーンアーキテクチャを採用していました。

それでも一回目の2021年でのリアーキテクチャでは、余分な関心ごとが混ざっており切り離すには苦労をしました。
2回目のリアーキテクチャでBaaS化して、その後に法改正を体験して各プロダクトチームから、プロダクト本体の修正に集中して行うことができて良かった！という意見を貰いました。
この2回のリアーキテクチャの経験をして、ドメイン蒸留とはこういうことなのか！？を後からぼんやりと理解してそれを去年のアドベントカレンダーで言語化したという流れでした。

## 高品質なインターフェース設計のキーポイント

### BaaS成功の鍵となる2つの品質側面

登壇スライドではさらっと触れるにとどめましたが、BaaS化の成否を分けるのは、I/Fをいかに高品質に設計できるかという点にあります。  
ここでいう高品質というのは2つの側面があると考えています。

1. BaaSのI/Fとして単一責務・高凝集であること
   シンプルなインターフェースで、背後に豊かな機能を隠蔽して、利用者の認知負荷を最小化
2. インターフェースに関わる具体的な実装及び開発プロセス自体が高い品質基準を満たしていること
   実装側と利用者側双方の開発者体験が良く、インターフェースと実装の乖離がないことが求められます。

後者の品質向上する具体的な取り組みついては以下の記事にまとめていますので、よかったら御覧ください。

https://zenn.dev/litalico/articles/re-architecting-rezept2

#### なぜインターフェース設計は難しいのか

前者を満たすインターフェースを設計するためには、細部まで徹底的にこだわり、神経を使っています。
なぜならBaaSのI/Fが良くないと認知負荷も高く使いづらく、最悪の場合にカバーできるユースケースに制約が生まれてプロダクト全体の品質が下がるからです。
言い換えると独り善がりなインターフェースで、意図が明確になっておらず結果が想像できない、若しくは想像していた使い方が誤認されて期待値が異なるなど、バグの温床にもなります。
凄く表現が難しいのですが、インターフェースがSimple過ぎても想定とは矛盾した使い方が出来てしまうし、Easy過ぎても対応できないケースが出てきてしまうのでバランスが難しいです。

### 設計時の具体的な取り組み

設計時の具体的な取り組みを上げると以下の様にになります。

* 論点を整理して複数チームと連携して合意を取る
* 設計意図や論点の元となる根拠を一箇所にまとめる
  情報格差をなくし、見直し時や途中から参加した人が理解できるようにして、議論のループを防ぐ
* 思い込みや、声の大きい特定の個人の意見が通ってしまわない様に、多様な意見をまとめる
  法解釈のブレを敢えて発散・集約させて論点漏れを防ぐ
* 設計パターンを考慮したガイドラインを参照して一貫性を保つ
  特定のメンバーの暗黙知に頼っていて、都度判断していてブレも発生してしまっていたものを正しく形式知化

上記取り組みについては、法改正時の経験から生まれたものです。
扱っているドメインのルールが複雑なので、それをうまく隠蔽して、尚且つ取り扱いのミスを防ぎつつ簡単に使えるインターフェースにするには、様々な資料を見ながら複数ある設計観点を判断していかなければなりません。

## 請求処理における複雑な依存関係

### 請求計算に必要な多様なデータ

この様々な資料を参照する必要があるのは請求のドメインルールが複雑で、関連する関心ごとが混ざっているからです。

請求処理で請求計算する際に依存しているデータには以下の様なものがあります。

* 障害福祉サービスの報酬算定のサービスごとの単位数表 
* サービス利用者の個別情報
  請求に必須となるデータ（受給者証情報、障害支援区分、利用者負担上限額管理情報など）
* 実際に提供されたサービスの実績記録
  請求の基礎となるデータ（提供日時、サービス内容、提供時間、担当職員の資格など）
* 請求額を増減させる加算・減算項目
  必要な人員配置、設備、または専門的支援に関する具体的な証明データや体制届出書の内容
* 請求業務で使用される標準的な様式（介護給付費等請求書、明細書、給付管理票など）に記載が義務付けられているデータ
* サービス提供から国保連への請求に至るまでの関連業務で発生する各種データ

上記の様なデータが幅広く、多岐にわたる業務で扱われ、発生しています。
これらの各種実績データをかき集めてきて請求計算を行うのですが、これを一つのインターフェースとしてまとめていくわけです。

業務視点の観点からいうと、請求業務は、これらのデータが発生する業務に依存しているとも言えます。

ここで、今回のテーマである『関心ごとにも依存関係がある』という話に繋がっていきます。

## 関心ごとの分離と依存関係の管理

### ドメインの階層化と責務の明確化


コアドメインであるレセプトの関心ごとを閉じ込め、専用チームを結成し、Rezept as a Serviceの立ち上げを行いました。
リアーキテクチャを行って「コアドメインを最も安定した位置に置く」という取り組みを行ってきたわけですが、関心ごとをうまく分離して

* コアドメインチームが扱う関心ごと
* サブドメイン（支援サブドメイン）チームが扱う関心ごと

それぞれが混ざらない様にしました。

#### BaaS化の効果

サブドメインチームのメンバーからは、法改正時に「プロダクト本体の修正に集中できて良かった！」という意見を貰いました。
これは専門チームを立ち上げてリソースを集中させた戦略的には「狙い通り」の効果があったと感じています。
サブドメインチームからは、コアドメインチームが扱う関心ごとの詳細を知らなくても済むようになります。これはコアドメインの関心ごとの複雑さを理解しやすく、簡易に使える様にインターフェースに閉じ込めることが出来ている結果だと考えています。

## 関心ごとの越境 - より良いインターフェース設計のために

### インターフェース設計の落とし穴


しかしこのインターフェースの設計には、一方の関心ごとだけを閉じ込めただけでは使い物にならないと考えています。

冒頭で記載した

> シンプルなインターフェースで、背後に豊かな機能を隠蔽して、利用者の認知負荷を最小化

これがいかに難しいかという点についてお話しします。
今回の請求に限って言えば、算定構造表をそのままインターフェースにするという、少々乱暴なアプローチも考えられます。

@[docswell](https://www.docswell.com/s/katzumi/KLQL3Q-decision-table-implementation-tips#p20)

こちらの表の条件（算定項目と呼びます）をそのままパラメータ化すれば単位数は算出することができます。
しかしながらこれをしてしまうと、請求ドメインの知識がパラメータに滲み出してしまい、法改正時にインターフェースを見直さないといけなくなり、パラメータを生成するロジックもまた改修しないといけなくなります。

このような事態は次回の法改正時に負債となるので、絶対に避けなければなりません。

#### 越境的思考の必要性

ではどうすれば良いのか？ということですが、戦略的なチーム構成としては関心ごとは別で独立していますが、越境して関心ごとを考える必要があると考えています。

例として

* コアドメインチームとして
	* 各種実績データがどの様に蓄積されるか？はわからない
	* 体制状況をデータで蓄積されてないかも知れないが、体制状況に紐づく支援データは存在するのではないか？
	  → 請求の元データとしては支援データのみでみなし算定OKとする
* 支援サブドメインチームとして
	* 指定基準や体制状況の届出では区分で申請するようになっているが、それが請求にどの様に定義・解釈されるか？はわからない
	* 扱う区分が法改正によって変わる、若しくは算定ルール上の見直しが入る可能性があるかも知れない
	  →　法改正で影響を少なくする為に、敢えて区分値ではなく詳細な数値として管理する

上記の様にお互いの関心ごとを跨いで考えることで、関心ごとの境界であるインターフェースを協議して決める際に、より柔軟で豊かな表現にすることが出来たり、連携がしやすく法改正の対応がしやすいデータ構造にすることが出来ます。

## 本質的複雑性への対処法

### 理想と現実のギャップ

理想論を言ってしまえば、システム全てを理解してそこに紐づく関心ごとも把握できれば完璧なインターフェースを設計することができるのですが、

* これだけ大規模且つ複雑なドメイン領域を一人で全てを把握するには認知負荷の限界を超える（キャパシティオーバーになる）  
  ドメイン知識だけの把握を考えても法改正時に差分が必ず発生するので、理解・把握するのにも時間が圧倒的に足りない
* 法改正時には改修範囲が多岐にわたるので、複数チームで取り組まないと間に合わない

上記の問題あるので難しいです。
やはり戦略的にチームを分けて考えることが望ましいです。

#### 関心ごとの適切な分割

特に法律に関する関心ごとが幅広くそれぞれのサイズが大きいので認知負荷も大変なことになります。

その関心ごとの **本質的複雑性** についてどの様に立ち向かうか？が課題となりますが、これは扱えるサイズまで分割にする必要があると考えています。

障害福祉領域で法制度という一つのドメインに見えるかも知れませんが、告示内容に記載している内容を細かく見ていくと

* 人員に関する基準
* 設備に関する基準
* 運営に関する基準
* 算定に関する基準

などがあります。
事業所の指定申請の指定基準から始まり、日々の支援や請求を行う際に守らないといけないビジネスルールが多数あります。
このルールの中で算定に関する基準（以降は算定基準）が一番複雑だったりします。
この算定基準を扱う請求業務を専任の請求担当に任せるというのは、全員が全ての法令知識を持ってないと支援が行えないということを減らす（認知負荷を軽減する）面で有効です。

この算定基準とその他の各種基準との関係ですが、原則的に、各種基準が守られて支援が行われた実績があれば、報酬として認めれる（＝算定が可能）という形になります。
つまり算定基準は、その他の基準全ての結果に依存しています。

#### 業務横断的なビジネスルールと越境的思考の重要性

これらのビジネスルールは各種業務に点在しています。各々の業務でそれぞれの基準が満たされるように各機能を提供していきます。
各業務の担当は、これらの基準を満たすように責務を持つことになります。
本来の業務上では各業務担当は自身の受け持つ担当部分の視点で基準を守り、担当外の業務については基準が守られている前提で日々の業務を行うと思います。
しかしながら、

* 後の人がチェックしてくれるから大丈夫だろう。
* 前の人が合格にしているから絶対ヨシ！

というインシデントが起きがちです。
このような責任範囲の隙間（ポテンヒット）による見落としに繋がるので、越境するという考え方は重要だと考えています。

これはシステム設計や開発時にも重要だと考えています。
関心の分離と抽象化がうまくいくと分業はうまくいきますが、間違うとサイロ化してしまいます。

* 悪いサイロ化
  この基準は担保されているのだろうか？
  → 誤って実績データが送られてきたのかも？
  　バリデーションで弾くのが良いのか？無視して算定しない方がよいのか？

* 良いサイロ化
  細かい算定の計算式・単位数まではわからない。
  でもこの算定の組み合わせはNGになるので、請求前までに弾いておこう

知らなくても良いことと、知っておくべきことを理解して設計を行うことが大事だと考えます。
コンテキストを跨いだ場合に、事細かく詳細まで知る必要はないが、『該当のコンポーネントがどこに影響するか（因果関係）』は知っておく必要があります。

#### 技術と組織の共進化

関心ごとの依存関係を明確にすることで、チーム間の責任境界が明確になります。
ただ、自チームの関心ごとに閉じこもらず、依存先・依存元の関心ごとを理解することで、より良い設計が可能になります。
依存関係を理解した上で適切に抽象化することで、各チームの認知負荷を最適化できると考えます。

コンウェイの法則が示すように、システムのアーキテクチャは組織構造を反映します。
逆に言えば、関心ごとの依存関係を理解することで、より効果的な組織設計も可能になると考えます。

## こぼれ話

冒頭で紹介した登壇のプレゼン資料ですが、 Slidevというツールを使って作成されています。
SlidevはMarkdown形式で記述します。
最近はnotebooklm等の生成AIでスライド資料の作成ができるという内容を見つけてClaudeで作成させてみました。

@[docswell](https://www.docswell.com/s/katzumi/53E6YL-domain-distillation)

元記事と他の自分のスライドを参考に生成してみましたが、ここまで書けるものなのですね。
案外内容が良かったので、これを超える内容にしなければ！という良い刺激になりました。

# 最後に

コアドメインを安定化することができ、今後はますます領域が広がるであろう支援サブドメインをどの様に拡張しやすく、法改正時にも確実な対応ができる様にしていくことが求められます。

その中でも障害福祉のドメインに向き合い、ドメインに磨きをかけていきたいと思います。
そしてドメインに磨きをかける上で、越境を積極的に行っていきたいと思います。

また新しい取り組みでも、戦略や戦術について成果や新しい気づき等がありましたら改めて発信できればと考えています。

:::message
明日は、[LITALICO Advent Calendar 2025](https://qiita.com/advent-calendar/2025/litalico) 19 日目の記事です。[@sayaka_hashi](https://qiita.com/sayaka_hashi) さん、　[@y_fushiki](https://qiita.com/y_fushiki)さん、[@yorim](https://qiita.com/yorim)と[@ti_aiuto](https://qiita.com/ti_aiuto)さんが担当し、豪華４本立てになります！どうぞお楽しみに！
:::
